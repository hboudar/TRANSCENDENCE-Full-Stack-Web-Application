services:
  client:
    build:
      context: .
      dockerfile: ./client/dockerfile
    container_name: client
    environment:
      - NODE_ENV=production
    networks:
      - transcendence
    restart: unless-stopped
    volumes:
      - uploads_data:/app/public/uploads   # Shared uploads volume

  server:
    build:
      context: .
      dockerfile: ./server/dockerfile
    container_name: server
    environment:
      - NODE_ENV=production
    networks:
      - transcendence
    restart: unless-stopped
    volumes:
      - server_logs:/var/log/transcendence   # logs only
      - uploads_data:/usr/src/app/uploads    # Shared uploads volume

  nginx:
    build:
      context: .
      dockerfile: ./nginx/dockerfile
    container_name: nginx
    ports:
      - "443:443"
    depends_on:
      - client
      - server
    networks:
      - transcendence
    restart: unless-stopped
    volumes:
      - uploads_data:/usr/share/nginx/uploads   # Shared uploads volume for serving files


  # prometheus:
  #   build:
  #     context: ./prometheus
  #     dockerfile: dockerfile
  #   container_name: prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #     - '--web.console.libraries=/usr/share/prometheus/console_libraries'
  #     - '--web.console.templates=/usr/share/prometheus/consoles'
  #     - '--web.external-url=/prometheus'
  #   volumes:
  #     - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #   expose:
  #     - "9090"
  #   networks:
  #     - transcendence
  #   restart: unless-stopped

  # grafana:
  #   build:
  #     context: ./grafana
  #     dockerfile: dockerfile
  #   container_name: grafana
  #   environment:
  #     - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}
  #     - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
  #     - GF_SERVER_ROOT_URL=${GF_SERVER_ROOT_URL}
  #     - GF_AUTH_ANONYMOUS_ENABLED=${GF_AUTH_ANONYMOUS_ENABLED}
  #     - GF_SERVER_SERVE_FROM_SUB_PATH=true
  #   depends_on:
  #     - prometheus
  #   volumes:
  #     - ./grafana/grafana.ini:/etc/grafana/grafana.ini:ro
  #     - ./grafana/datasources:/etc/grafana/provisioning/datasources
  #     - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
  #     - grafana_data:/var/lib/grafana
  #   expose:
  #     - "3000"
  #   networks:
  #     - transcendence
  #   restart: unless-stopped

  # node_exporter:
  #   build:
  #     context: ./node_exporter
  #     dockerfile: dockerfile
  #   container_name: node_exporter
  #   expose:
  #     - "9100"
  #   networks:
  #     - transcendence
  #   restart: unless-stopped

  # es_certs:
  #   build:
  #     context: ./elk/certs
  #   container_name: es_certs
  #   user: "0"
  #   volumes:
  #     - transcendence_certs:/usr/share/elasticsearch/config/certs
  #   networks:
  #     - transcendence
  #   restart: "no"

  # elasticsearch:
  #   build:
  #     context: ./elk/elasticsearch
  #     dockerfile: Dockerfile
  #   container_name: elasticsearch
  #   environment:
  #     - ES_JAVA_OPTS=-Xms1g -Xmx2g
  #     - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
  #   volumes:
  #     - elastic_data:/usr/share/elasticsearch/data
  #     - transcendence_certs:/usr/share/elasticsearch/config/certs
  #   expose:
  #     - "9200"
  #   networks:
  #     - transcendence
  #   depends_on:
  #     - es_certs
  #   healthcheck:
  #     test: ["CMD", "curl", "-k", "-u", "elastic:${ELASTIC_PASSWORD}", "https://localhost:9200/_cluster/health"]
  #     interval: 20s
  #     timeout: 10s
  #     retries: 10
  #   restart: unless-stopped
  #   mem_limit: 4g

  # es_setup:
  #   build:
  #     context: ./elk/es_setup
  #   container_name: es_setup
  #   environment:
  #     - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
  #     - KIBANA_SYSTEM_PASSWORD=${KIBANA_SYSTEM_PASSWORD}
  #     - LOGSTASH_INTERNAL_PASSWORD=${LOGSTASH_INTERNAL_PASSWORD}
  #     - BEATS_SYSTEM_PASSWORD=${BEATS_SYSTEM_PASSWORD}
  #   depends_on:
  #     elasticsearch:
  #       condition: service_healthy
  #   networks:
  #     - transcendence
  #   restart: "no"

  # kibana:
  #   build:
  #     context: ./elk/kibana
  #     dockerfile: Dockerfile
  #   container_name: kibana
  #   environment:
  #     - KIBANA_SYSTEM_PASSWORD=${KIBANA_SYSTEM_PASSWORD}
  #     - KIBANA_ENCRYPTION_KEY=${KIBANA_ENCRYPTION_KEY}
  #   volumes:
  #     - transcendence_certs:/usr/share/kibana/config/certs:ro
  #   depends_on:
  #     elasticsearch:
  #       condition: service_healthy
  #     es_setup:
  #       condition: service_completed_successfully
  #   ports:
  #     - "5601:5601"
  #   networks:
  #     - transcendence
  #   restart: unless-stopped

  # logstash:
  #   build:
  #     context: ./elk/logstash
  #     dockerfile: Dockerfile
  #   container_name: logstash
  #   environment:
  #     - LOGSTASH_INTERNAL_PASSWORD=${LOGSTASH_INTERNAL_PASSWORD}
  #   volumes:
  #     - transcendence_certs:/usr/share/logstash/config/certs:ro
  #   depends_on:
  #     elasticsearch:
  #       condition: service_healthy
  #     es_setup:
  #       condition: service_completed_successfully
  #   expose:
  #     - "5044"
  #   networks:
  #     - transcendence
  #   restart: unless-stopped

  # filebeat:
  #   build:
  #     context: ./elk/filebeat
  #     dockerfile: Dockerfile
  #   container_name: filebeat
  #   user: root
  #   volumes:
  #     - server_logs:/var/log/transcendence:ro
  #     - transcendence_certs:/data:ro
  #   depends_on:
  #     logstash:
  #       condition: service_started
  #     es_setup:
  #       condition: service_completed_successfully
  #   networks:
  #     - transcendence
  #   restart: unless-stopped

networks:
  transcendence:
    name: transcendence

volumes:
  grafana_data:
  elastic_data:
  prometheus_data:
  transcendence_certs:
  server_logs:
  uploads_data:    # Shared volume for user uploads
