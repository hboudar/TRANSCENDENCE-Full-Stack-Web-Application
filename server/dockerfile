FROM node:18-alpine

WORKDIR /usr/src/app

# Install Python and build dependencies for native modules like sqlite3
# Clean cache and retry on failure to handle network issues
RUN apk update && apk add --no-cache python3 make g++ || \
    (rm -rf /var/cache/apk/* && apk update && apk add --no-cache python3 make g++)

COPY ./server/package*.json ./

RUN npm install --only=production   # safer than npm ci for lockfile mismatch

COPY ./server ./

# Create uploads directory for volume mount
RUN mkdir -p /usr/src/app/uploads

CMD ["npm", "start"]
